name: Docker Image CI for GCP

on:
    push:
        branches:
            - 'main'

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Code checkout
              uses: actions/checkout@v2

            - name: Install GCP CLI
              uses: google-github-actions/setup-gcloud@v0
              with:
                project_id: ${{ secrets.GCP_PROJECT_ID }}
                service_account_key: ${{ secrets.GCP_APPLICATION_CREDENTIALS }}
                export_default_credentials: true
            
            - name: Set up JDK 21 for x64
              uses: actions/setup-java@v4
              with:
                java-version: '21'
                distribution: 'temurin'
                architecture: x64
            
            - name: Build with Maven
              run: mvn --batch-mode --update-snapshots verify

            - name: Build & Push Docker Image
              env:
                GOOGLE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
              run:
                gcloud auth configure-docker us-central1-doker.pkg.dev
                docker build -t us-central1-docker.pkg.dev/$GCP_PROJECT_ID/wellness-tracking-service-containers/login-service:latest --file Dockerfile .
                docker push us-central1-docker.pkg.dev/$GCP_PROJECT_ID/wellness-tracking-service-containers/login-service:latest
